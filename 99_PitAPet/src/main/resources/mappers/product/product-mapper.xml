<?xml version="1.0" encoding="UTF-8"?>

<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.kh.pitapet.product.model.dao.ProductMapper">

	<resultMap type="Product" id="productListResultMap">
		<id property="no" column="NO"/>
		<result property="title" column="TITLE"/>
		<result property="content" column="CONTENT"/>
		<result property="price" column="PRICE"/>
		<result property="createdDate" column="CREATED_DATE"/>
		<result property="modifyDate" column="MODIFY_DATE"/>
	</resultMap>
	
	<resultMap type="ProductInfo" id="productInfoResultMap">
		<id property="no" column="NO"/>
		<result property="productNo" column="PRODUCT_NO"/>
		<result property="colorName" column="COLOR_NAME"/>
		<result property="colorCode" column="COLOR_CODE"/>
		<result property="imageName" column="IMAGE_NAME"/>
		<result property="stock" column="STOCK"/>
		<result property="status" column="STATUS"/>
		<result property="createdDate" column="CREATED_DATE"/>
		<result property="modifyDate" column="MODIFY_DATE"/>
	</resultMap>
	
	<resultMap type="Product" extends="productListResultMap" id="productDetailResultMap">
		<collection property="productInfoes" javaType="arraylist" columnPrefix="I_" resultMap="productInfoResultMap"/>
	</resultMap>
	
	<select id="selectProductNo" resultType="_int">
		SELECT P.NO
		FROM PRODUCT P
		JOIN PRODUCT_INFO I ON (P.NO = I.PRODUCT_NO)
		WHERE I.STOCK > 0
		AND I.STATUS = 'Y'
	</select>
	
	<select id="selectProductByNo" parameterType="_int" resultMap="productDetailResultMap">
		SELECT P.NO, 
		       P.TITLE, 
		       P.CONTENT, 
		       P.PRICE,
		       P.CREATED_DATE, 
		       P.MODIFY_DATE,
		       I.NO AS I_NO,
		       I.PRODUCT_NO AS I_PRODUCT_NO,
		       I.COLOR_NAME AS I_COLOR_NAME,
		       I.COLOR_CODE AS I_COLOR_CODE,
		       I.IMAGE_NAME AS I_IMAGE_NAME,
		       I.STATUS AS I_STATUS,
		       I.STOCK AS I_STOCK,
		       I.CREATED_DATE AS I_CREATED_DATE,
		       I.MODIFY_DATE AS I_MODIFY_DATE
		 FROM PRODUCT P
		 JOIN PRODUCT_INFO I ON (P.NO = I.PRODUCT_NO)
		 WHERE I.STATUS = 'Y'
		 AND P.NO = #{no}
	</select>
	
	<select id="getProductInfoCount" parameterType="map" resultType="_int">
		SELECT COUNT(*)
		FROM PRODUCT P
		JOIN PRODUCT_INFO I ON (P.NO = I.PRODUCT_NO) 
		WHERE I.STATUS = 'Y'
	</select>
	
	<select id="findAll" parameterType="map" resultMap="productDetailResultMap">
		SELECT P.NO, 
		       P.TITLE, 
		       P.CONTENT, 
		       P.PRICE,
		       P.CREATED_DATE, 
		       P.MODIFY_DATE,
		       I.NO AS I_NO,
		       I.PRODUCT_NO AS I_PRODUCT_NO,
		       I.COLOR_NAME AS I_COLOR_NAME,
		       I.COLOR_CODE AS I_COLOR_CODE,
		       I.IMAGE_NAME AS I_IMAGE_NAME,
		       I.STATUS AS I_STATUS,
		       I.STOCK AS I_STOCK,
		       I.CREATED_DATE AS I_CREATED_DATE,
		       I.MODIFY_DATE AS I_MODIFY_DATE
		 FROM PRODUCT P
		 JOIN PRODUCT_INFO I ON (P.NO = I.PRODUCT_NO)
		 WHERE I.STATUS = 'Y'
		 ORDER BY P.NO, I.NO
	</select>
	
	<select id="selectProductInfoByNo" parameterType="_int" resultMap="productDetailResultMap">
		SELECT P.NO, 
		       P.TITLE, 
		       P.CONTENT, 
		       P.PRICE,
		       P.CREATED_DATE, 
		       P.MODIFY_DATE,
		       I.NO AS I_NO,
		       I.PRODUCT_NO AS I_PRODUCT_NO,
		       I.COLOR_NAME AS I_COLOR_NAME,
		       I.COLOR_CODE AS I_COLOR_CODE,
		       I.IMAGE_NAME AS I_IMAGE_NAME,
		       I.STATUS AS I_STATUS,
		       I.STOCK AS I_STOCK,
		       I.CREATED_DATE AS I_CREATED_DATE,
		       I.MODIFY_DATE AS I_MODIFY_DATE
		 FROM PRODUCT P
		 JOIN PRODUCT_INFO I ON (P.NO = I.PRODUCT_NO)
		 WHERE I.STATUS = 'Y'
		 AND I.NO = #{no}
	</select>
	
	<update id="updateStatusProductInfo" parameterType="map">
		UPDATE PRODUCT_INFO SET STATUS = #{status} WHERE NO = #{no}
	</update>
	
	<select id="selectAllProduct" resultMap="productListResultMap">
		SELECT NO, 
			   TITLE, 
			   CONTENT, 
			   PRICE, 
			   CREATED_DATE, 
			   MODIFY_DATE
		FROM PRODUCT
		ORDER BY NO
	</select>
	
	<insert id="insertProductInfo" parameterType="ProductInfo"
			useGeneratedKeys="true" keyColumn="NO" keyProperty="no">
		INSERT INTO PRODUCT_INFO (
			NO,
			PRODUCT_NO,
			COLOR_NAME,
			COLOR_CODE,
			IMAGE_NAME,
			STOCK,
			STATUS,
			CREATED_DATE,
			MODIFY_DATE
		)VALUES(
			SEQ_INFO_NO.NEXTVAL, 
			#{productNo}, 
			#{colorName}, 
			#{colorCode}, 
			#{imageName}, 
			#{stock}, 
			'Y', 
			DEFAULT, 
			DEFAULT
			)
	</insert>
	
	<select id="selectProductInfoByINo" parameterType="_int" resultMap="productDetailResultMap">
		SELECT P.NO, 
		       P.TITLE, 
		       P.CONTENT, 
		       P.PRICE,
		       P.CREATED_DATE, 
		       P.MODIFY_DATE,
		       I.NO AS I_NO,
		       I.PRODUCT_NO AS I_PRODUCT_NO,
		       I.COLOR_NAME AS I_COLOR_NAME,
		       I.COLOR_CODE AS I_COLOR_CODE,
		       I.IMAGE_NAME AS I_IMAGE_NAME,
		       I.STATUS AS I_STATUS,
		       I.STOCK AS I_STOCK,
		       I.CREATED_DATE AS I_CREATED_DATE,
		       I.MODIFY_DATE AS I_MODIFY_DATE
		 FROM PRODUCT P
		 JOIN PRODUCT_INFO I ON (P.NO = I.PRODUCT_NO)
		 WHERE I.STATUS = 'Y'
		 AND I.NO = #{no}
	</select>
	
	<insert id="insertProduct" parameterType="Product"
			useGeneratedKeys="true" keyColumn="NO" keyProperty="no">
		INSERT INTO PRODUCT (
		    NO,
		    TITLE,
		    CONTENT,
		    PRICE,
		    CREATED_DATE,
		    MODIFY_DATE
		)VALUES(
		    SEQ_PRODUCT_NO.NEXTVAL, 
		    #{title}, 
		    #{content}, 
		    #{price}, 
		    DEFAULT, 
		    DEFAULT
		)
	</insert>
	
	<update id="updateProduct" parameterType="Product">
		UPDATE PRODUCT
		SET
			TITLE = #{title},
			CONTENT = #{content},
			PRICE = #{price},
			MODIFY_DATE = SYSDATE
		WHERE NO = #{no}
	</update>
	
	<select id="getProductCount" resultType="_int">
		SELECT COUNT(*)
		FROM PRODUCT
	</select>
	
	<select id="findProduct" resultMap="productListResultMap">
		SELECT NO, 
			   TITLE, 
			   CONTENT, 
			   PRICE, 
			   CREATED_DATE, 
			   MODIFY_DATE
		FROM PRODUCT
		ORDER BY NO
	</select>
	
	<select id="getProductInfoCountByPNo" parameterType="_int" resultType="_int">
		SELECT COUNT(*)
		FROM PRODUCT_INFO I
		JOIN PRODUCT P ON (P.NO = I.PRODUCT_NO)
		WHERE I.PRODUCT_NO = #{no}
		AND I.STATUS = 'Y'
	</select>
	
	<delete id="deleteProduct" parameterType="_int">
		DELETE FROM PRODUCT
		WHERE NO = #{no}
	</delete>
	
	<select id="selectProductByPNo" parameterType="_int" resultMap="productListResultMap">
		SELECT NO, TITLE, CONTENT, PRICE, CREATED_DATE, MODIFY_DATE
		FROM PRODUCT
		WHERE NO = #{no}
	</select>
	
	
	
	
	
	<select id="selectOnlyProductByNo" parameterType="_int" resultMap="productListResultMap">
		SELECT NO, 
			   TITLE, 
			   CONTENT, 
			   PRICE, 
			   CREATED_DATE, 
			   MODIFY_DATE
		FROM PRODUCT
		WHERE NO = #{no}
	</select>
	
	<select id="selectCountByTitle" resultType="_int">
		SELECT COUNT(*)
		FROM PRODUCT
		WHERE REPLACE(TITLE, ' ', '') = #{title}
	</select>

</mapper>  